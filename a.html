<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Paint - Pro</title>
    <style>
        :root {
            --ui-bg: #c0c0c0;
            --shadow: #808080;
            --light: #ffffff;
            --active-blue: #000080;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background: var(--shadow);
            font-family: "MS Sans Serif", Tahoma, sans-serif;
        }

        .main-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        /* Sidebar UI */
        .sidebar {
            width: 56px;
            background: var(--ui-bg);
            border-right: 2px solid var(--shadow);
            display: flex;
            flex-direction: column;
            padding: 4px;
            gap: 2px;
            z-index: 10;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
        }

        .btn {
            width: 24px;
            height: 24px;
            background: var(--ui-bg);
            border: 2px solid;
            border-color: var(--light) var(--shadow) var(--shadow) var(--light);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            padding: 0;
        }

        .btn.active {
            border-color: var(--shadow) var(--light) var(--light) var(--shadow);
            background: #e0e0e0;
            outline: 1px dotted black;
            outline-offset: -4px;
        }

        /* Canvas Wrapper */
        #workspace {
            flex-grow: 1;
            background: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        canvas {
            background: white;
            image-rendering: pixelated;
            cursor: crosshair;
            display: block;
        }

        /* Bottom Palette */
        .bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: var(--ui-bg);
            border-top: 2px solid var(--shadow);
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
        }

        .palette-grid {
            display: grid;
            grid-template-columns: repeat(14, 1fr);
            gap: 1px;
        }

        .swatch {
            width: 14px;
            height: 14px;
            border: 1px inset white;
            cursor: pointer;
        }

        .current-color-box {
            width: 28px;
            height: 28px;
            border: 2px inset white;
            background: #000;
        }

        #size-slider {
            width: 60px;
        }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="sidebar">
        <div class="tool-grid">
            <button class="btn active" onclick="setMode('brush')" title="Pencil">‚úèÔ∏è</button>
            <button class="btn" onclick="setMode('rect')" title="Rectangle">‚ñ≠</button>
            <button class="btn" onclick="setMode('circle')" title="Circle">‚óØ</button>
            <button class="btn" onclick="setMode('fill')" title="Fill Bucket">ü´ó</button>
            <button class="btn" onclick="clearCanvas()" title="Clear">üóëÔ∏è</button>
            <button class="btn" onclick="save()" title="Save">üíæ</button>
        </div>
    </div>

    <div id="workspace">
        <canvas id="canvas"></canvas>
        
        <div class="bottom-bar">
            <div class="current-color-box" id="activeIndicator"></div>
            <div class="palette-grid" id="swatches"></div>
            <input type="range" id="size-slider" min="1" max="30" value="5">
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const workspace = document.getElementById('workspace');
    const swatches = document.getElementById('swatches');
    const activeIndicator = document.getElementById('activeIndicator');

    let drawing = false;
    let mode = 'brush';
    let color = '#000000';
    let startX, startY;
    let snapshot;

    const colors = [
        '#000000', '#808080', '#800000', '#808000', '#008000', '#008080', '#000080', '#800080', '#808040', '#004040', '#0080FF', '#004080', '#4000FF', '#804000',
        '#FFFFFF', '#C0C0C0', '#FF0000', '#FFFF00', '#00FF00', '#00FFFF', '#0000FF', '#FF00FF', '#FFFF80', '#00FF80', '#80FFFF', '#8080FF', '#FF0080', '#FF8040'
    ];

    function init() {
        canvas.width = workspace.clientWidth;
        canvas.height = workspace.clientHeight - 40; // Adjusted for bottom bar
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
    }

    colors.forEach(c => {
        const s = document.createElement('div');
        s.className = 'swatch';
        s.style.background = c;
        s.onclick = () => { color = c; activeIndicator.style.background = c; };
        swatches.appendChild(s);
    });

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function getCoords(e) {
        const r = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
        return [x, y];
    }

    canvas.onmousedown = canvas.ontouchstart = (e) => {
        if (mode === 'fill') {
            const [x, y] = getCoords(e);
            floodFill(Math.floor(x), Math.floor(y), hexToRgb(color));
            return;
        }
        drawing = true;
        [startX, startY] = getCoords(e);
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
    };

    window.onmousemove = window.ontouchmove = (e) => {
        if (!drawing) return;
        const [currX, currY] = getCoords(e);
        ctx.putImageData(snapshot, 0, 0);
        ctx.strokeStyle = color;
        ctx.lineWidth = document.getElementById('size-slider').value;

        if (mode === 'brush') {
            ctx.lineTo(currX, currY);
            ctx.stroke();
            snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        } else if (mode === 'rect') {
            ctx.strokeRect(startX, startY, currX - startX, currY - startY);
        } else if (mode === 'circle') {
            ctx.beginPath();
            const rad = Math.sqrt((currX - startX)**2 + (currY - startY)**2);
            ctx.arc(startX, startY, rad, 0, Math.PI * 2);
            ctx.stroke();
        }
    };

    window.onmouseup = window.ontouchend = () => {
        drawing = false;
        ctx.beginPath();
    };

    // INVISIBLE PASTE
    window.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const img = new Image();
                img.onload = () => {
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(img, 20, 20);
                };
                img.src = URL.createObjectURL(blob);
            }
        }
    });

    // BASIC FLOOD FILL (Simplified)
    function floodFill(x, y, fillRgb) {
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imgData.data;
        const targetIdx = (y * canvas.width + x) * 4;
        const targetR = data[targetIdx], targetG = data[targetIdx+1], targetB = data[targetIdx+2];

        if (targetR === fillRgb.r && targetG === fillRgb.g && targetB === fillRgb.b) return;

        const queue = [[x, y]];
        while (queue.length > 0) {
            const [cx, cy] = queue.pop();
            const idx = (cy * canvas.width + cx) * 4;

            if (data[idx] === targetR && data[idx+1] === targetG && data[idx+2] === targetB) {
                data[idx] = fillRgb.r; data[idx+1] = fillRgb.g; data[idx+2] = fillRgb.b; data[idx+3] = 255;
                if (cx > 0) queue.push([cx - 1, cy]);
                if (cx < canvas.width - 1) queue.push([cx + 1, cy]);
                if (cy > 0) queue.push([cx, cy - 1]);
                if (cy < canvas.height - 1) queue.push([cx, cy + 1]);
            }
        }
        ctx.putImageData(imgData, 0, 0);
    }

    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return {r, g, b};
    }

    function clearCanvas() { ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height); }
    function save() { const l = document.createElement('a'); l.download='paint.png'; l.href=canvas.toDataURL(); l.click(); }

    window.onresize = init;
    init();
</script>

</body>
</html>