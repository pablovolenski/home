<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kollaborative Tafel</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #059669; --bg: #e5e7eb; --card-border: #d1d5db; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); touch-action: none; font-family: -apple-system, sans-serif; }
        
        /* Die Tafel (Canvas Container) */
        #tafel-container { width: 5000px; height: 5000px; position: relative; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 30px 30px; }
        
        /* Zeichen-Ebene */
        #zeichen-layer { position: absolute; top: 0; left: 0; z-index: 5; pointer-events: none; }
        #zeichen-layer.active { pointer-events: auto; cursor: crosshair; }

        /* Navigation oben */
        .top-bar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .url-display { background: #f1f5f9; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-family: monospace; cursor: pointer; border: 1px solid #e2e8f0; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Werkzeugleiste unten */
        .toolbar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 40px; display: flex; gap: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 2000; align-items: center; }
        .tool-btn { border: none; background: #f1f5f9; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .tool-btn.active { background: var(--primary); color: white; transform: scale(1.1); }
        
        /* Karten & Notizen */
        .card { position: absolute; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); min-width: 200px; z-index: 10; border: 1px solid var(--card-border); touch-action: none; }
        .handle { height: 35px; background: #f8fafc; cursor: move; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; font-size: 10px; font-weight: bold; color: #64748b; border-radius: 12px 12px 0 0; }
        .card-content { padding: 10px; display: flex; flex-direction: column; }
        textarea { width: 100%; border: none; outline: none; resize: none; font-size: 16px; background: transparent; min-height: 100px; }
        
        .del-btn { color: #ef4444; cursor: pointer; font-size: 16px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <strong style="font-size: 18px;">Tafel</strong>
            <div class="url-display" onclick="copyBoardUrl()" id="url-text">URL kopieren</div>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="downloadPNG()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">PNG Export</button>
            <button onclick="window.location.href='index.html'" style="border:none; background:none; font-weight:bold; color:#64748b; cursor:pointer;">Beenden</button>
        </div>
    </div>

    <div class="toolbar">
        <button class="tool-btn active" id="btn-select" onclick="setTool('select')" title="Ausw√§hlen">üñ±Ô∏è</button>
        <button class="tool-btn" onclick="spawn('note')" title="Notiz">üìù</button>
        <button class="tool-btn" onclick="spawn('table')" title="Tabelle">üìä</button>
        <div style="width:1px; height:30px; background:#ddd; margin: 0 5px;"></div>
        <button class="tool-btn" id="btn-pencil" onclick="setTool('pencil')" title="Stift">‚úèÔ∏è</button>
        <button class="tool-btn" id="btn-rect" onclick="setTool('rect')" title="Rechteck">‚¨ú</button>
        <button class="tool-btn" id="btn-circle" onclick="setTool('circle')" title="Kreis">‚≠ï</button>
        <button class="tool-btn" onclick="clearDrawings()" style="color:red" title="Zeichnungen l√∂schen">üóëÔ∏è</button>
    </div>

    <div id="tafel-container">
        <canvas id="zeichen-layer" width="5000" height="5000"></canvas>
    </div>

    <script>
        // --- FIREBASE SETUP ---
        const firebaseConfig = {
          apiKey: "AIzaSyB6PzmLTjSSdm_ptrf_V3oxEDoajRM79_c",
          authDomain: "collabcanvas-ba771.firebaseapp.com",
          databaseURL: "https://collabcanvas-ba771-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "collabcanvas-ba771",
          storageBucket: "collabcanvas-ba771.firebasestorage.app",
          messagingSenderId: "889941054639",
          appId: "1:889941054639:web:a1c236f44344d03f85f05a",
          measurementId: "G-VWQ41CPW6N"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('id') || 'lobby';
        const roomRef = db.ref('rooms/' + roomId);
        const drawRef = db.ref('drawings/' + roomId);

        document.getElementById('url-text').innerText = window.location.href;
        const mainCanvas = document.getElementById('zeichen-layer');
        const ctx = mainCanvas.getContext('2d');
        let currentTool = 'select';
        let isDrawing = false;
        let startX, startY;

        // --- ZEICHEN LOGIK ---
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + tool)?.classList.add('active');
            mainCanvas.classList.toggle('active', tool !== 'select');
        }

        mainCanvas.onmousedown = (e) => startDraw(e);
        mainCanvas.onmousemove = (e) => duringDraw(e);
        window.onmouseup = () => endDraw();

        function startDraw(e) {
            if(currentTool === 'select') return;
            isDrawing = true;
            const rect = mainCanvas.getBoundingClientRect();
            startX = e.clientX - rect.left + window.scrollX;
            startY = e.clientY - rect.top + window.scrollY;
        }

        function duringDraw(e) {
            if(!isDrawing || currentTool === 'select') return;
            // Lokale Vorschau k√∂nnte hier implementiert werden
        }

        function endDraw() {
            if(!isDrawing) return;
            isDrawing = false;
            // Hier w√ºrde die Form in Firebase gespeichert werden
        }

        function clearDrawings() {
            if(confirm("Alle Zeichnungen l√∂schen?")) {
                ctx.clearRect(0,0, 5000, 5000);
                drawRef.remove();
            }
        }

        // --- KARTEN LOGIK ---
        function spawn(type) {
            const newCardRef = roomRef.push();
            newCardRef.set({
                type, x: window.scrollX + 250, y: window.scrollY + 250,
                w: 250, h: 200, content: type === 'note' ? "" : { rows: 3, cols: 2, data: {} }
            });
        }

        roomRef.on('child_added', (snap) => renderCard(snap.val(), snap.key));
        roomRef.on('child_changed', (snap) => updateCardUI(snap.val(), snap.key));
        roomRef.on('child_removed', (snap) => document.getElementById(snap.key)?.remove());

        function renderCard(data, id) {
            const el = document.createElement('div');
            el.id = id; el.className = 'card';
            el.innerHTML = `
                <div class="handle"><span>${data.type === 'note' ? 'NOTIZ' : 'TABELLE'}</span><span class="del-btn" onclick="removeCard('${id}')">‚úï</span></div>
                <div class="card-content" id="content-${id}"></div>
            `;
            document.getElementById('tafel-container').appendChild(el);
            
            const area = el.querySelector('.card-content');
            if (data.type === 'note') {
                area.innerHTML = `<textarea placeholder="Schreibe etwas...">${data.content || ''}</textarea>`;
                area.querySelector('textarea').oninput = (e) => roomRef.child(id).update({ content: e.target.value });
            }
            setupInteract(el, id);
            updateCardUI(data, id);
        }

        function updateCardUI(data, id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.style.transform = `translate(${data.x}px, ${data.y}px)`;
            el.setAttribute('data-x', data.x);
            el.setAttribute('data-y', data.y);
        }

        function setupInteract(el, id) {
            interact(el).draggable({
                allowFrom: '.handle',
                listeners: {
                    move(event) {
                        if(currentTool !== 'select') return;
                        const x = (parseFloat(el.getAttribute('data-x')) || 0) + event.dx;
                        const y = (parseFloat(el.getAttribute('data-y')) || 0) + event.dy;
                        el.style.transform = `translate(${x}px, ${y}px)`;
                        el.setAttribute('data-x', x);
                        el.setAttribute('data-y', y);
                    },
                    end() {
                        roomRef.child(id).update({ x: parseFloat(el.getAttribute('data-x')), y: parseFloat(el.getAttribute('data-y')) });
                    }
                }
            });
        }

        function removeCard(id) { if(confirm("L√∂schen?")) roomRef.child(id).remove(); }
        function copyBoardUrl() { navigator.clipboard.writeText(window.location.href); alert("URL kopiert!"); }
        async function downloadPNG() {
            const container = document.getElementById('tafel-container');
            html2canvas(container, { width: 5000, height: 5000 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `tafel-${roomId}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        window.scrollTo(2300, 2300);
    </script>
</body>
</html>