<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kollaborative Tafel</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #e5e7eb; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); touch-action: none; font-family: sans-serif; }
        
        #tafel-container { width: 5000px; height: 5000px; position: relative; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 30px 30px; }
        
        /* The Drawing Board (Layered behind notes) */
        #zeichen-layer { position: absolute; top: 0; left: 0; z-index: 5; pointer-events: none; }
        #zeichen-layer.active { pointer-events: auto; cursor: crosshair; }

        /* Navigation & UI */
        .top-bar { position: fixed; top: 0; left: 0; right: 0; height: 40px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 2000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .url-display { background: #f1f5f9; padding: 4px 10px; border-radius: 10px; font-size: 10px; font-family: monospace; cursor: pointer; }

        .toolbar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background: white; padding: 5px; border-radius: 30px; display: flex; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 2000; border: 1px solid #ddd; }
        .tool-btn { border: none; background: transparent; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        .tool-btn.active { background: var(--primary); color: white; }
        
        /* Minimalist Card UI */
        .card { position: absolute; background: white; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; border: 1px solid #ccc; overflow: hidden; }
        .handle { height: 8px; background: #eee; cursor: move; border-bottom: 1px solid #ddd; position: relative; }
        .handle:hover { background: #ddd; }
        .del-btn { position: absolute; top: -4px; right: 2px; color: #aaa; cursor: pointer; font-size: 9px; line-height: 8px; }
        
        .card-content { padding: 4px; }
        textarea { width: 100%; border: none; outline: none; resize: none; font-size: 13px; background: transparent; display: block; padding: 0; line-height: 1.2; }
        
        /* Ultra-Minimalist Table */
        .table-tools { display: flex; gap: 5px; margin-bottom: 2px; font-size: 9px; color: var(--primary); }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        td { border: 1px solid #ddd; padding: 0; margin: 0; }
        td input { 
            width: 100%; border: none; outline: none; background: transparent; 
            font-size: 12px; padding: 1px 2px; margin: 0; display: block;
            height: 1.2em; /* Matches font height */
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="url-display" onclick="copyBoardUrl()" id="url-text">URL KOPIEREN</div>
        <div style="display:flex; gap:5px;">
            <button onclick="downloadPNG()" style="font-size:10px; cursor:pointer;">PNG</button>
            <button onclick="window.location.href='index.html'" style="font-size:10px; cursor:pointer;">X</button>
        </div>
    </div>

    <div class="toolbar">
        <button class="tool-btn active" id="btn-select" onclick="setTool('select')">üñ±Ô∏è</button>
        <button class="tool-btn" onclick="spawn('note')">üìù</button>
        <button class="tool-btn" onclick="spawn('table')">üìä</button>
        <div style="width:1px; height:20px; background:#eee;"></div>
        <button class="tool-btn" id="btn-pencil" onclick="setTool('pencil')">‚úèÔ∏è</button>
        <button class="tool-btn" id="btn-rect" onclick="setTool('rect')">‚¨ú</button>
        <button class="tool-btn" id="btn-circle" onclick="setTool('circle')">‚≠ï</button>
        <button class="tool-btn" onclick="clearDrawings()" style="color:red">üóëÔ∏è</button>
    </div>

    <div id="tafel-container">
        <canvas id="zeichen-layer" width="5000" height="5000"></canvas>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyB6PzmLTjSSdm_ptrf_V3oxEDoajRM79_c",
          authDomain: "collabcanvas-ba771.firebaseapp.com",
          databaseURL: "https://collabcanvas-ba771-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "collabcanvas-ba771",
          storageBucket: "collabcanvas-ba771.firebasestorage.app",
          messagingSenderId: "889941054639",
          appId: "1:889941054639:web:a1c236f44344d03f85f05a",
          measurementId: "G-VWQ41CPW6N"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('id') || 'lobby';
        const roomRef = db.ref('rooms/' + roomId);
        const drawRef = db.ref('drawings/' + roomId);

        const canvas = document.getElementById('zeichen-layer');
        const ctx = canvas.getContext('2d');
        let currentTool = 'select';
        let isDrawing = false;
        let points = [];

        function setTool(t) {
            currentTool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+t)?.classList.add('active');
            canvas.classList.toggle('active', t !== 'select');
        }

        // --- IMPROVED DRAWING ---
        const getCoords = (e) => {
            const r = canvas.getBoundingClientRect();
            return {
                x: (e.clientX || e.touches?.[0].clientX) - r.left + window.scrollX,
                y: (e.clientY || e.touches?.[0].clientY) - r.top + window.scrollY
            };
        };

        const startDraw = (e) => {
            if(currentTool === 'select') return;
            isDrawing = true;
            const pos = getCoords(e);
            points = [pos];
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        };

        const moveDraw = (e) => {
            if(!isDrawing) return;
            const pos = getCoords(e);
            points.push(pos);
            
            if(currentTool === 'pencil') {
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = "#000";
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        };

        const stopDraw = () => {
            if(!isDrawing) return;
            isDrawing = false;
            if(points.length > 1) {
                drawRef.push({ type: currentTool, path: points });
            }
            points = [];
        };

        canvas.onmousedown = startDraw;
        canvas.onmousemove = moveDraw;
        window.onmouseup = stopDraw;
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveDraw(e); });
        canvas.addEventListener('touchend', stopDraw);

        drawRef.on('child_added', (snap) => {
            const d = snap.val();
            if(!d.path) return;
            ctx.beginPath();
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.moveTo(d.path[0].x, d.path[0].y);
            
            if(d.type === 'pencil') {
                d.path.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.stroke();
            } else if(d.type === 'rect') {
                const last = d.path[d.path.length-1];
                ctx.strokeRect(d.path[0].x, d.path[0].y, last.x - d.path[0].x, last.y - d.path[0].y);
            } else if(d.type === 'circle') {
                const last = d.path[d.path.length-1];
                const r = Math.sqrt(Math.pow(last.x - d.path[0].x, 2) + Math.pow(last.y - d.path[0].y, 2));
                ctx.arc(d.path[0].x, d.path[0].y, r, 0, 2 * Math.PI);
                ctx.stroke();
            }
        });

        function clearDrawings() { if(confirm("L√∂schen?")) { drawRef.remove(); ctx.clearRect(0,0,5000,5000); } }

        // --- CARDS & TABLES ---
        function spawn(type) {
            const ref = roomRef.push();
            const content = (type === 'note') ? "" : { rows: 2, cols: 2, data: {} };
            ref.set({ type, x: window.scrollX + 150, y: window.scrollY + 150, w: 200, h: 100, content });
        }

        roomRef.on('child_added', (snap) => renderCard(snap.val(), snap.key));
        roomRef.on('child_changed', (snap) => updateCardUI(snap.val(), snap.key));
        roomRef.on('child_removed', (snap) => document.getElementById(snap.key)?.remove());

        function renderCard(data, id) {
            const el = document.createElement('div');
            el.id = id; el.className = 'card';
            el.innerHTML = `<div class="handle"><span class="del-btn" onclick="removeCard('${id}')">x</span></div><div class="card-content" id="c-${id}"></div>`;
            document.getElementById('tafel-container').appendChild(el);
            updateCardUI(data, id);
            setupInteract(el, id);
        }

        function updateCardUI(data, id) {
            const el = document.getElementById(id);
            const area = document.getElementById(`c-${id}`);
            if(!el || !area) return;
            
            el.style.transform = `translate(${data.x}px, ${data.y}px)`;
            el.style.width = data.w + 'px';
            el.style.height = data.h + 'px';
            el.setAttribute('data-x', data.x); el.setAttribute('data-y', data.y);

            if(document.activeElement.closest(`#${id}`)) return;

            if(data.type === 'note') {
                area.innerHTML = `<textarea placeholder="...">${data.content || ''}</textarea>`;
                area.querySelector('textarea').oninput = (e) => roomRef.child(id).update({content: e.target.value});
            } else {
                let html = `<div class="table-tools"><span onclick="modTab('${id}','r')">+ Z</span><span onclick="modTab('${id}','c')">+ S</span></div><table>`;
                const r = data.content.rows || 2, c = data.content.cols || 2, d = data.content.data || {};
                for(let i=0; i<r; i++) {
                    html += '<tr>';
                    for(let j=0; j<c; j++) {
                        const v = d[`${i}-${j}`] || '';
                        html += `<td><input oninput="updCell('${id}',${i},${j},this.value)" value="${v}"></td>`;
                    }
                    html += '</tr>';
                }
                area.innerHTML = html + `</table>`;
            }
        }

        function updCell(id, r, c, v) { roomRef.child(`${id}/content/data/${r}-${c}`).set(v); }
        function modTab(id, mode) {
            roomRef.child(id).once('value', s => {
                const c = s.val().content;
                if(mode === 'r') c.rows++; else c.cols++;
                roomRef.child(id).update({content: c});
            });
        }

        function setupInteract(el, id) {
            interact(el).draggable({
                allowFrom: '.handle',
                listeners: {
                    move(event) {
                        const x = (parseFloat(el.getAttribute('data-x')) || 0) + event.dx;
                        const y = (parseFloat(el.getAttribute('data-y')) || 0) + event.dy;
                        el.style.transform = `translate(${x}px, ${y}px)`;
                        el.setAttribute('data-x', x); el.setAttribute('data-y', y);
                    },
                    end() { roomRef.child(id).update({x: parseFloat(el.getAttribute('data-x')), y: parseFloat(el.getAttribute('data-y'))}); }
                }
            }).resizable({
                edges: { right: true, bottom: true },
                listeners: {
                    move(event) { Object.assign(event.target.style, {width: `${event.rect.width}px`, height: `${event.rect.height}px`}); },
                    end(event) { roomRef.child(id).update({w: event.rect.width, h: event.rect.height}); }
                }
            });
        }

        function removeCard(id) { if(confirm("L√∂schen?")) roomRef.child(id).remove(); }
        function copyBoardUrl() { navigator.clipboard.writeText(window.location.href); alert("Kopiert!"); }
        function downloadPNG() { html2canvas(document.getElementById('tafel-container'), {width:5000, height:5000}).then(c => { const l=document.createElement('a'); l.download='tafel.png'; l.href=c.toDataURL(); l.click(); }); }
        window.scrollTo(2300, 2300);
    </script>
</body>
</html>