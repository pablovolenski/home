<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tafel V13</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #e5e7eb; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); touch-action: none; font-family: sans-serif; }
        #tafel-container { width: 5000px; height: 5000px; position: relative; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 30px 30px; }
        #paint-layer { position: absolute; top: 0; left: 0; z-index: 5; pointer-events: none; }
        #paint-layer.active { pointer-events: auto; cursor: crosshair; }

        .top-bar { position: fixed; top: 0; left: 0; right: 0; height: 35px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 2000; border-bottom: 1px solid #ddd; }
        
        .toolbar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background: white; padding: 6px; border-radius: 30px; display: flex; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 2000; border: 1px solid #ddd; align-items: center; }
        .tool-btn { border: none; background: transparent; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        .tool-btn.active { background: var(--primary); color: white; }
        
        #color-picker { width: 24px; height: 24px; border: none; padding: 0; cursor: pointer; background: none; border-radius: 50%; overflow: hidden; }

        /* Minimalist Cards */
        .card { position: absolute; border-radius: 2px; z-index: 10; border: 1px solid #999; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .handle { height: 12px; background: rgba(0,0,0,0.05); cursor: move; flex-shrink: 0; position: relative; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .del-btn { position: absolute; top: -3px; right: 2px; color: #666; cursor: pointer; font-size: 10px; font-weight: bold; }
        
        .card-content { padding: 0 !important; margin: 0 !important; flex-grow: 1; display: flex; flex-direction: column; }
        textarea { width: 100%; border: none; outline: none; resize: none; font-size: 13px; background: transparent; padding: 2px; margin: 0; flex-grow: 1; line-height: 1.1; display: block; box-sizing: border-box; }
        
        /* Table Zero-Padding */
        table { border-collapse: collapse; width: 100%; table-layout: fixed; margin: 0; padding: 0; border: none; }
        td { border: 1px solid rgba(0,0,0,0.1); padding: 0 !important; height: 1.3em; }
        td input { width: 100%; border: none; outline: none; background: transparent; font-size: 12px; padding: 0 2px; display: block; height: 1.3em; box-sizing: border-box; }
        
        .table-tools { display: flex; gap: 6px; font-size: 9px; color: var(--primary); padding: 2px 4px; background: rgba(255,255,255,0.8); border-bottom: 1px solid #eee; }
        .table-tools span { cursor: pointer; font-weight: bold; }
        .table-tools .red { color: #ef4444; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="font-size:9px; color:#999;" onclick="copyBoardUrl()">V13 - URL KOPIEREN</div>
        <div style="display:flex; gap:8px;">
            <button onclick="document.getElementById('file-up').click()" style="font-size:9px;">UPLOAD</button>
            <input type="file" id="file-up" style="display:none" onchange="uploadJSON(this)">
            <button onclick="downloadJSON()" style="font-size:9px;">JSON</button>
            <button onclick="downloadPNG()" style="font-size:9px;">PNG</button>
        </div>
    </div>

    <div class="toolbar">
        <button class="tool-btn active" id="btn-select" onclick="setTool('select')">üñ±Ô∏è</button>
        <button class="tool-btn" onclick="spawn('note')">üìù</button>
        <button class="tool-btn" onclick="spawn('table')">üìä</button>
        <div style="width:1px; height:15px; background:#eee;"></div>
        <button class="tool-btn" id="btn-pencil" onclick="setTool('pencil')">‚úèÔ∏è</button>
        <input type="color" id="color-picker" value="#000000" onchange="updateColor(this.value)">
        <button class="tool-btn" onclick="clearAll()" style="color:red">üóëÔ∏è</button>
    </div>

    <div id="tafel-container">
        <canvas id="paint-layer" width="5000" height="5000"></canvas>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyB6PzmLTjSSdm_ptrf_V3oxEDoajRM79_c",
          authDomain: "collabcanvas-ba771.firebaseapp.com",
          databaseURL: "https://collabcanvas-ba771-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "collabcanvas-ba771",
          storageBucket: "collabcanvas-ba771.firebasestorage.app",
          messagingSenderId: "889941054639",
          appId: "1:889941054639:web:a1c236f44344d03f85f05a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const roomId = new URLSearchParams(window.location.search).get('id') || 'lobby';
        const roomRef = db.ref('rooms/' + roomId);
        const drawRef = db.ref('drawings/' + roomId);

        const canvas = document.getElementById('paint-layer');
        const ctx = canvas.getContext('2d');
        ctx.lineWidth = 2; ctx.lineCap = 'round';
        
        let currentTool = 'select';
        let isDrawing = false;
        let lx, ly;
        let activeColor = "#000000";

        function setTool(t) {
            currentTool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+t)?.classList.add('active');
            canvas.classList.toggle('active', t === 'pencil');
        }

        function updateColor(val) {
            activeColor = val;
            ctx.strokeStyle = val;
            // If a note is being edited, update its color in DB
            const activeId = document.activeElement.closest('.card')?.id;
            if(activeId) roomRef.child(activeId).update({ color: val });
        }

        const getPos = (e) => {
            const r = canvas.getBoundingClientRect();
            const cx = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const cy = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            return { x: cx - r.left + window.scrollX, y: cy - r.top + window.scrollY };
        };

        canvas.onmousedown = (e) => {
            if(currentTool !== 'pencil') return;
            isDrawing = true;
            const p = getPos(e); lx = p.x; ly = p.y;
            ctx.beginPath(); ctx.moveTo(lx, ly);
        };

        canvas.onmousemove = (e) => {
            if(!isDrawing) return;
            const p = getPos(e);
            ctx.strokeStyle = activeColor;
            ctx.lineTo(p.x, p.y); ctx.stroke();
            drawRef.push({x1: lx, y1: ly, x2: p.x, y2: p.y, c: activeColor});
            lx = p.x; ly = p.y;
        };

        window.onmouseup = () => isDrawing = false;
        canvas.addEventListener('touchstart', (e) => { if(currentTool==='pencil') { e.preventDefault(); canvas.onmousedown(e.touches[0]); } }, {passive:false});
        canvas.addEventListener('touchmove', (e) => { if(currentTool==='pencil') { e.preventDefault(); canvas.onmousemove(e.touches[0]); } }, {passive:false});

        drawRef.on('child_added', s => {
            const d = s.val();
            ctx.beginPath(); 
            ctx.strokeStyle = d.c || '#000';
            ctx.moveTo(d.x1, d.y1); ctx.lineTo(d.x2, d.y2); 
            ctx.stroke();
        });

        function spawn(type) {
            roomRef.push().set({ 
                type, x: window.scrollX + 250, y: window.scrollY + 250, 
                w: 180, h: 80, color: '#ffffff',
                content: type==='note'?'':{rows:2,cols:2,data:{}} 
            });
        }

        roomRef.on('child_added', (s) => {
            const el = document.createElement('div');
            el.id = s.key; el.className = 'card';
            el.innerHTML = `<div class="handle"><span class="del-btn" onclick="removeObj('${s.key}')">x</span></div><div class="card-content" id="c-${s.key}"></div>`;
            document.getElementById('tafel-container').appendChild(el);
            setupInteract(el, s.key);
            updateUI(s.val(), s.key);
        });

        roomRef.on('child_changed', (s) => updateUI(s.val(), s.key));
        roomRef.on('child_removed', (s) => document.getElementById(s.key)?.remove());

        function updateUI(data, id) {
            const el = document.getElementById(id), area = document.getElementById(`c-${id}`);
            if(!el || !area) return;
            el.style.backgroundColor = data.color || '#ffffff';
            el.style.width = data.w+'px'; el.style.height = data.h+'px';
            el.style.transform = `translate(${data.x}px, ${data.y}px)`;
            el.setAttribute('data-x', data.x); el.setAttribute('data-y', data.y);

            if(document.activeElement.closest(`#${id}`)) return;

            if(data.type === 'note') {
                area.innerHTML = `<textarea placeholder="..."> ${data.content||''}</textarea>`;
                area.querySelector('textarea').oninput = (e) => roomRef.child(id).update({content: e.target.value});
            } else {
                let html = `<div class="table-tools">
                    <span onclick="modTab('${id}','r',1)">+Z</span><span class="red" onclick="modTab('${id}','r',-1)">-Z</span>
                    <span onclick="modTab('${id}','c',1)">+S</span><span class="red" onclick="modTab('${id}','c',-1)">-S</span>
                </div><table>`;
                for(let i=0; i<data.content.rows; i++){
                    html += '<tr>';
                    for(let j=0; j<data.content.cols; j++) html += `<td><input oninput="updCell('${id}',${i},${j},this.value)" value="${(data.content.data||{})[`${i}-${j}`]||''}"></td>`;
                    html += '</tr>';
                }
                area.innerHTML = html + '</table>';
            }
        }

        function setupInteract(el, id) {
            interact(el).draggable({ allowFrom: '.handle', listeners: { move(e) { 
                    const x = (parseFloat(el.getAttribute('data-x'))||0)+e.dx, y=(parseFloat(el.getAttribute('data-y'))||0)+e.dy;
                    el.style.transform=`translate(${x}px, ${y}px)`; el.setAttribute('data-x',x); el.setAttribute('data-y',y);
                }, end() { roomRef.child(id).update({x:parseFloat(el.getAttribute('data-x')), y:parseFloat(el.getAttribute('data-y'))}); }
            }}).resizable({ edges: {right:true, bottom:true}, listeners: {
                move(e) { Object.assign(e.target.style, {width:`${e.rect.width}px`, height:`${e.rect.height}px`}); },
                end(e) { roomRef.child(id).update({w:e.rect.width, h:e.rect.height}); }
            }});
        }

        function modTab(id, m, delta) {
            roomRef.child(id).once('value', s => {
                const c = s.val().content;
                if(m === 'r') c.rows = Math.max(1, (c.rows || 1) + delta);
                else c.cols = Math.max(1, (c.cols || 1) + delta);
                roomRef.child(id).update({content: c});
            });
        }

        function downloadJSON() { 
            Promise.all([roomRef.once('value'), drawRef.once('value')]).then(snaps => {
                const blob = new Blob([JSON.stringify({o:snaps[0].val(), d:snaps[1].val()})], {type:'application/json'});
                const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tafel.json'; a.click();
            });
        }
        function uploadJSON(input) {
            const reader = new FileReader();
            reader.onload = (e) => { const data = JSON.parse(e.target.result); roomRef.set(data.o); drawRef.set(data.d); location.reload(); };
            reader.readAsText(input.files[0]);
        }
        function downloadPNG() { html2canvas(document.getElementById('tafel-container'), {width:5000, height:5000}).then(c => { const a=document.createElement('a'); a.download='tafel.png'; a.href=c.toDataURL(); a.click(); }); }
        function updCell(id, r, c, v) { roomRef.child(`${id}/content/data/${r}-${c}`).set(v); }
        function removeObj(id) { if(confirm("L√∂schen?")) roomRef.child(id).remove(); }
        function clearAll() { if(confirm("Tafel leeren?")) { drawRef.remove(); ctx.clearRect(0,0,5000,5000); } }
        function copyBoardUrl() { navigator.clipboard.writeText(window.location.href); alert("URL kopiert!"); }
        window.scrollTo(2400, 2400);
    </script>
</body>
</html>